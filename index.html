<!DOCTYPE html>
<html>
<head>
    <title>Assembly</title>
    <script src="https://code.iconify.design/1/1.0.2/iconify.min.js"></script>
    <script src="jquery-3.3.1.min.js"></script>
    <script src="codemirror/codemirror.js"></script>
    <link rel="stylesheet" href="codemirror/codemirror.css">
    <link rel="stylesheet" href="codemirror/vscdark.css">
    <script src="codemirror/simple.js"></script>
    <script src="codemirror/mins.js"></script>
    <script src="assembler.js"></script>
    <script src="parser.js"></script>
    <script src="cpu.js"></script>
    <style type="text/css">
        body{
            margin: 0px;
            height: 100vh;
            overflow: hidden;
        }

        #editor{
            width: 100%;
            height: 100%;
            border-spacing: 0px;
        }

        #toolbar{
            height: 40px;
            background-color: #212121;
        }

        #editarea{
            padding: 0px;
            width: 100vw;
        }

        #console{
            background-color: #1a1a1a;
            border-top: 1px solid #808080;
            padding: 0px;
            vertical-align: top;
            height: 150px;
        }

        #console_pre{
            color: white;
            padding: 0px;
            margin: 0px;
            height: 150px;
            width: 100vw;
            max-height: 150px;
            font-size: 14px;
            overflow-y: scroll;
            overflow-wrap: break-word;
            white-space: pre-wrap;
        }

        #consolebar{
            color: white;
            background-color: #212121;
            padding: 1px 0px;
            height: 20px;
        }

        .consbutton{
            display: inline-block;
            color: white;
            box-sizing: border-box;
            -moz-user-select: none;
            -webkit-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        .consbutton:hover{
            background-color: #313131;
        }

        .iconify{
            font-size: 18px;
            position: relative;
        }

        .button{
            display: inline-block;
            color: white;
            font-size: 14px;
            font-family: "Roboto", sans-serif;
            padding: 12px;
            height: 40px;
            box-sizing: border-box;
            -moz-user-select: none;
            -webkit-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        .button:hover{
            background-color: #313131;
        }

        .button[disabled="1"]{
            color: #626262;
        }

        #savebutton[active="true"]{
            border-bottom: 2px solid white;
        }

        #savebutton[active="false"]{
            color: #626262;
        }

        .debug-active-line{
            background-color: #ffffff40;
        }

        #debug-panel{
            display: none;
            background-color: #252525;
            height: 40px;
        }

        .widget{
            font-family: "Roboto", sans-serif;
            font-size: 14px;
            display: flex;
            position: absolute;
            background-color: #1a1a1a;
            color: white;
            z-index: 10;
            border: 1px solid #808080;
            flex-direction: column;
            min-width: 120px;
        }

        .widget-header{
            padding: 2px;
            cursor: move;
            background-color: #212121;
            color: white;
            height: 18px;
        }

        .widget-button:hover{
            cursor: default;
            background-color: #313131;
        }

        ::-webkit-scrollbar {
          width: 10px;
          height: 20px;
        }

        ::-webkit-scrollbar-track {
          background: #a1a1a1; 
        }

        ::-webkit-scrollbar-thumb {
          background: #666; 
        }

        ::-webkit-scrollbar-thumb:hover {
          background: #444; 
        }
    </style>
</head>
<body>
    <div id="watcher" class="widget" style='display: none;left: calc(50vw - 50px);top: 20vh;'>
        <div class='widget-header'>
            <span style="vertical-align: top;">Registers</span>
            <span class="iconify widget-button" data-icon="mdi:window-close" data-inline="false" style="float: right;" onclick="closeWidget('watcher');$('#regwidbutton')[0].style['border-bottom'] = null"></span>
            <span class="iconify widget-button" data-icon="mdi:window-minimize" data-inline="false" style="float: right;" onclick="toggleCol('watcher')"></span>
        </div>
        <table class='widget-cont' style="font-family: consolas;">
            <tr><td style="padding-right: 20px;">r1</td><td id="watcher-r1" style="min-width: 120px;">0000 NUL (0)</td></tr>
            <tr><td style="padding-right: 20px;">r2</td><td id="watcher-r2" style="min-width: 120px;">0000 NUL (0)</td></tr>
            <tr><td style="padding-right: 20px;">r3</td><td id="watcher-r3" style="min-width: 120px;">0000 NUL (0)</td></tr>
            <tr><td style="padding-right: 20px;">r4</td><td id="watcher-r4" style="min-width: 120px;">0000 NUL (0)</td></tr>
            <tr><td style="padding-right: 20px;">r5</td><td id="watcher-r5" style="min-width: 120px;">0000 NUL (0)</td></tr>
            <tr><td style="padding-right: 20px;">r6</td><td id="watcher-r6" style="min-width: 120px;">0000 NUL (0)</td></tr>
            <tr><td style="padding-right: 20px;">r7</td><td id="watcher-r7" style="min-width: 120px;">0000 NUL (0)</td></tr>
            <tr><td style="padding-right: 20px;">r8</td><td id="watcher-r8" style="min-width: 120px;">0000 NUL (0)</td></tr>
            <tr><td style="padding-right: 20px;">a0</td><td id="watcher-rb" style="min-width: 120px;">0000 NUL (0)</td></tr>
            <tr><td style="padding-right: 20px;">a1</td><td id="watcher-ra" style="min-width: 120px;">0000 NUL (0)</td></tr>
            <tr><td style="padding-right: 20px;">a2</td><td id="watcher-r9" style="min-width: 120px;">0000 NUL (0)</td></tr>
            <tr><td style="padding-right: 20px;">fp</td><td id="watcher-rc" style="min-width: 120px;">0000 NUL (0)</td></tr>
            <tr><td style="padding-right: 20px;">sp</td><td id="watcher-rd" style="min-width: 120px;">0000 NUL (0)</td></tr>
            <tr><td style="padding-right: 20px;">ip</td><td id="watcher-re" style="min-width: 120px;">0000 NUL (0)</td></tr>
            <tr><td style="padding-right: 20px;">rs</td><td id="watcher-rf" style="min-width: 120px;">0000 NUL (0)</td></tr>
        </table>
    </div>
    <div id="lblist" class="widget" style='display: none;left: calc(50vw - 50px);top: 20vh;'>
        <div class='widget-header'>
            <span style="vertical-align: top;">Labels</span>
            <span class="iconify widget-button" data-icon="mdi:window-close" data-inline="false" style="float: right;" onclick="closeWidget('lblist');$('#lblwidbutton')[0].style['border-bottom'] = null"></span>
            <span class="iconify widget-button" data-icon="mdi:window-minimize" data-inline="false" style="float: right;" onclick="toggleCol('lblist')"></span>
        </div>
        <table id="lblisttable" class='widget-cont' style="font-family: consolas;">
            <!-- <tr><td style="padding-right: 20px;">r1</td><td id="watcher-r1" style="min-width: 120px;"></td></tr> -->
        </table>
    </div>
    <table id='editor'>
        <tr id="toolbar"><td style="padding: 0px;">
            <div class='button' id="buildbutton" onclick="build()">
                <span class="iconify" data-icon="mdi:settings" data-inline="false" style="top: -2px;"></span>    
                <span style="vertical-align: top;">Build</span>
            </div>
            <div class='button' id="runbutton" onclick="runcode()" disabled='1'>
                <span class="iconify" data-icon="mdi:play" data-inline="false" style="top: -2px;"></span>
                <span style="vertical-align: top;">Run</span>
            </div>
            <div class='button' id="savebutton" onclick="savecode()">
                <span class="iconify" data-icon="mdi:content-save" data-inline="false" style="top: -2px;"></span>
                <span style="vertical-align: top;">Save</span>
            </div>
            <div class='button' id="downbutton" onclick="downloadCode()">
                <span class="iconify" data-icon="mdi:download" data-inline="false" style="top: -2px;"></span>
                <span style="vertical-align: top;">Download</span>
            </div>
            <div class='button' id="debugbutton" onclick="toogleDebug()" disabled='1'>
                <span class="iconify" data-icon="mdi:bug" data-inline="false" style="top: -2px;"></span>
                <span style="vertical-align: top;">Debug</span>
            </div>
            <div id='debug-panel'>
                <div class='button' id="runstepbutton" onclick="debugRunCode()">
                    <span id="runstepbutton-play" class="iconify" data-icon="mdi:play" data-inline="false" style="top: -2px;"></span>
                    <span id="runstepbutton-step" class="iconify" data-icon="mdi:step-forward" data-inline="false" style="top: -2px;display: none"></span>
                    <span id="runstepbutton-pause" class="iconify" data-icon="mdi:pause" data-inline="false" style="top: -2px;display: none"></span>
                </div>
                <div class='button' id="stepbutton" onclick="stepCode()" disabled='1'>
                    <span class="iconify" data-icon="mdi:debug-step-into" data-inline="false" style="top: -2px;"></span>
                </div>
                <div class='button' id="regwidbutton" onclick="showWidget('watcher');$('#regwidbutton')[0].style['border-bottom'] = '2px solid white'">
                    <span class="iconify" data-icon="mdi:chip" data-inline="false" style="top: -2px;"></span>
                </div>
                <div class='button' id="lblwidbutton" onclick="showWidget('lblist');$('#lblwidbutton')[0].style['border-bottom'] = '2px solid white'">
                    <span class="iconify" data-icon="mdi-format-list-bulleted-square" data-inline="false" style="top: -2px;"></span>
                </div>
            </div>
            <div class='button' id="docsbutton" onclick="window.open('docs/index.html', '_blank')" style="float: right;">
                <span class="iconify" data-icon="mdi:book-open-outline" data-inline="false" style="top: -2px;"></span>
                <span style="vertical-align: top;">Docs</span>
            </div>
            <!-- <div class='button' id="examplesbutton" onclick="" style="float: right;">
                <span class="iconify" data-icon="mdi:arrow-down-drop" data-inline="false" style="top: -2px;"></span>
                <span style="vertical-align: top;">Examples</span>
            </div> -->
        </td></tr>
        <tr style="padding: 0px;">
            <td id='editarea'></td>
        </tr>
        <tr style="padding: 0px;">
            <td id="console">
                <div id='consolebar'>
                    <div onclick="term.innerHTML = ''">
                        <span class="iconify consbutton" data-icon="mdi:cancel" data-inline="false" style="top: 1;"></span>
                    </div>
                </div>
                <pre id="console_pre"></pre>
            </td>
        </tr>
    </table>
    <script type="text/javascript">
        editor = CodeMirror($('#editarea')[0],{
            value: `    jmp start

string: .data "hello world\\n"

start:
    ld a0, $13
    ld r1, 0
loop:
    ldb a1, [r1+string]
    sys
    inc r1
    cmp a1, 0
    jne loop`,
            mode:  "mins",
            lineNumbers: true,
            gutters: ["CodeMirror-linenumbers", "breakpoints"],
            theme: "vscode-dark",
        });

        editor.on("gutterClick", function(cm, n) {
            var info = cm.lineInfo(n);
            if(info.gutterMarkers){
                cm.setGutterMarker(n, "breakpoints", null);
                for (var i = breakpoints.length - 1; i >= 0; i--) {
                    if(breakpoints[i]==info.line) breakpoints.splice(i,1)
                }
            }else{
                cm.setGutterMarker(n, "breakpoints", makeMarker());
                breakpoints.push(info.line)
            }
        });

        editor.on("change",function (cm) {
            $("#savebutton")[0].setAttribute("active",'true');
        })

        if(localStorage.getItem('cm_code')!=null){
            editor.getDoc().setValue(localStorage.getItem('cm_code'));
            $("#savebutton")[0].setAttribute("active",'false');
        }

        function makeMarker() {
          var marker = document.createElement("div");
          marker.style.color = "#f22";
          marker.innerHTML = "●";
          return marker;
        }

        breakpoints = []
        mem_breakpoints = {}
        macros = {}
        mach = ""

        debugLastActiveLine = -1;

        running = false
        debugging = false
        debugInit = false
        debugPanel = false

        function runcode() {
            if($("#runbutton")[0].getAttribute("disabled")=='1') return;
            if(!running){
                svm.mem.fill(0)
                svm.loadHex(mach)
                running = true
                $("#debugbutton")[0].setAttribute("disabled",'1');
                $("#runbutton")[0].setAttribute("disabled",1);
                $("#buildbutton")[0].setAttribute("disabled",'1');
                svm.set_reg(14,256)
                svm.set_reg(15,0)
                svm.set_flag(3,0)
                for (var i = 1; i < 13; i++) {
                    svm.set_reg(i,0)
                }
                id = setTimeout(()=>{
                    while(!svm.get_flag(3)){
                        svm.step()
                    }
                    $("#runbutton")[0].setAttribute("disabled",0);
                    $("#buildbutton")[0].setAttribute("disabled",'0');
                    $("#debugbutton")[0].setAttribute("disabled",'0');
                    running = false
                },0)
            }else if(running){
                //svm.set_flag(3,0);
            }
        }

        function toogleDebug() {
            if($("#debugbutton")[0].getAttribute("disabled")=='1') return;
            if(!debugPanel){
                $("#debug-panel")[0].style['display'] = "inline-block";
                debugPanel = true;
                initDebug();
            }else{
                stopDebug();
            }
        }

        function pauseDebug() {
            clearInterval(debugRunId);
            debugRunId=0;
            debugging = false;
            $("#runstepbutton-pause")[0].style["display"] = "none";
            $("#runstepbutton-step")[0].style["display"] = null;
            $("#stepbutton")[0].setAttribute("disabled",'0');
        }

        function stopDebug() {
            widgets_Z = 10
            closeWidget("watcher");
            closeWidget("lblist");
            $('#regwidbutton')[0].style['border-bottom'] = null
            $('#lblwidbutton')[0].style['border-bottom'] = null
            clearInterval(debugRunId);
            debugRunId=0;
            debugging = false;
            debugInit = false;
            debugPanel = false;
            $("#runstepbutton-pause")[0].style["display"] = "none";
            $("#runstepbutton-step")[0].style["display"] = "none";
            $("#runstepbutton-play")[0].style["display"] = null;
            $("#runbutton")[0].setAttribute("disabled",'0');
            $("#buildbutton")[0].setAttribute("disabled",'0');
            $("#stepbutton")[0].setAttribute("disabled",'1');
            $("#debugbutton")[0].style["border-bottom"] = null;
            $("#debug-panel")[0].style['display'] = "none";
            if(debugLastActiveLine!=-1){
                editor.removeLineClass(debugLastActiveLine,"background","debug-active-line")
                debugLastActiveLine=-1;
            }
        }

        function initDebug() {
            $("#buildbutton")[0].setAttribute("disabled",'1');
            debugInit = true;
            $("#runbutton")[0].setAttribute("disabled",'1');
            $("#stepbutton")[0].setAttribute("disabled",'0');
            $("#debugbutton")[0].style["border-bottom"] = "2px solid white";
            $("#runstepbutton-play")[0].style["display"] = "none";
            $("#runstepbutton-step")[0].style["display"] = null;
            svm.mem.fill(0)
            svm.loadHex(mach)
            svm.set_reg(14,256)
            svm.set_reg(15,0)
            svm.set_flag(3,0)
            for (var i = 1; i < 13; i++) {
                svm.set_reg(i,0)
                $("#watcher-r"+ i.toString(16))[0].innerHTML = svm.get_reg(i).toString(16).padStart(4,'0')+" NUL (0)"
            }
            debugLastActiveLine = mem_breakpoints[svm.get_reg(14)];
            editor.addLineClass(debugLastActiveLine,"background","debug-active-line")

            for (var i = breakpoints.length - 1; i >= 0; i--) {
                var line = breakpoints[i];
                if(editor.lineInfo(line)==null) breakpoints.splice(i,1)
            }
        }

        function stepCode() {
            if(debugInit){
                if(debugLastActiveLine!=undefined) editor.removeLineClass(debugLastActiveLine,"background","debug-active-line")
                svm.step()
                for (var i = 1; i < 16; i++) {
                    num = svm.get_reg(i)
                    charcode = num >= 0x20 && num <= 0x7e ? "'"+String.fromCharCode(num)+"'" : asciiCode(num)
                    $("#watcher-r"+ i.toString(16))[0].innerHTML = `${num.toString(16).padStart(4,'0')} ${charcode} (${num})`
                }
                debugLastActiveLine = mem_breakpoints[svm.get_reg(14)];
                if(debugLastActiveLine==undefined) debugLastActiveLine = -1
                if(debugLastActiveLine) editor.addLineClass(debugLastActiveLine,"background","debug-active-line")
                if(svm.get_flag(3)){
                    stopDebug();
                }
            }
        }

        let debugRunId = 0;
        function debugRunCode() {
            if(!debugInit && !running){
                initDebug();
                return
            }
            if(debugInit){
                if(!debugRunId){
                    debugging = true;
                    $("#runstepbutton-step")[0].style["display"] = "none";
                    $("#runstepbutton-pause")[0].style["display"] = null;
                    $("#stepbutton")[0].setAttribute("disabled",'1');

                    debugRunId = setInterval(()=>{
                        stepCode()
                        if(breakpoints.includes(debugLastActiveLine)){
                            pauseDebug()
                        }
                    },0)
                }else{
                    pauseDebug();
                }
            }
        }

        function savecode() {
            localStorage.setItem('cm_code', editor.getValue());
            $("#savebutton")[0].setAttribute("active",'false');
        }

        asmer = new Assembler()
        svm = new VirtualMachine()
        svm.set_reg(14,0x100)

        term = document.getElementById("console_pre")
        function terminal(s) {
            term.innerHTML += s
            term.scrollTop = term.scrollHeight;
        }

        function Error(e){
            term.innerHTML += "<span style='color: red'>"+("Error: Line " + (asmer.line+1)+ ': ' + e)+"\n</span>"
            term.scrollTop = term.scrollHeight;
            throw "Line " + (asmer.line+1)+ ': ' + e;
        }

        function Warn(e) {
            term.innerHTML += "<span style='color: lightblue'>"+("Warning: Line " + (asmer.line+1)+ ': ' + e)+"\n</span>"
            term.scrollTop = term.scrollHeight;
        }

        function build() {
            if($("#buildbutton")[0].getAttribute("disabled")=='1') return;
            $("#runbutton")[0].setAttribute("disabled",'0');
            $("#debugbutton")[0].setAttribute("disabled",'0');
            savecode();
            let t0 = performance.now();
            mach = asmer.assemble(editor.getValue())
            let t1 = performance.now();
            terminal("Build finished in "+((t1-t0)/1000).toFixed(3)+"s\n\n")
            $("#lblisttable")[0].innerHTML = ""
            for(lbl in asmer.labels){
                $("#lblisttable")[0].innerHTML += `<tr><td style="padding-right: 20px;">${lbl}</td><td>${asmer.labels[lbl].toString(16).padStart(4,"0")}</td></tr>`
            }
        }

        function downloadCode() {
            data = editor.getValue()
            var file = new Blob([data], {type: "text/plain"});
            var a = document.createElement("a")
            var url = URL.createObjectURL(file);
            a.href = url;
            a.download = "m160_WebAssembler.asm";
            document.body.appendChild(a);
            a.click();
            setTimeout(function() {
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);  
            }, 0); 
        }

        widgets_Z = 10
        dragElement(document.getElementById("watcher"));
        dragElement(document.getElementById("lblist"));
        function dragElement(elmnt) {
          var pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
          elmnt.children[0].onmousedown = dragMouseDown;

          function dragMouseDown(e) {
            e = e || window.event;
            e.preventDefault();
            pos3 = e.clientX;
            pos4 = e.clientY;
            document.onmouseup = closeDragElement;
            document.onmousemove = elementDrag;
            elmnt.style["z-index"] = ++widgets_Z;
          }

          function elementDrag(e) {
            e = e || window.event;
            e.preventDefault();
            pos1 = pos3 - e.clientX;
            pos2 = pos4 - e.clientY;
            pos3 = e.clientX;
            pos4 = e.clientY;
            elmnt.style.top = (elmnt.offsetTop - pos2) + "px";
            elmnt.style.left = (elmnt.offsetLeft - pos1) + "px";
          }

          function closeDragElement() {
            document.onmouseup = null;
            document.onmousemove = null;
          }
        }

        function toggleCol(id) {
            wid = document.getElementById(id);
            wid_cont = wid.getElementsByClassName('widget-cont')[0]
            if(wid_cont.style['display'] == 'none'){
                wid_cont.style['display'] = null;
            }else{
                wid_cont.style['display'] = 'none';
            }
        }

        function closeWidget(id) {
            wid = document.getElementById(id).style['display'] = 'none';
        }

        function showWidget(id) {
            document.getElementById(id).style['display'] = null;
        }

        function asciiCode(num) {
            if(num==0)  return 'NUL'
            if(num==9)  return 'TAB'
            if(num==10) return 'LF&nbsp;'
            if(num==13) return 'CR&nbsp;'
            if(num==27) return 'ESC'
            return '---'
        }
    </script>
</body>
</html>